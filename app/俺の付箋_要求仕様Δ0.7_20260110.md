# 俺の付箋 (Ore no Fusen) 要求仕様書 Δ0.7

## プロジェクト概要
**「俺の付箋」**は、ローカル Markdown ファイルをデスクトップ上に貼り付けられた「付箋」のように扱うためのミニマリスト向けアプリケーションです。

## ユースケース定義 (Use Cases Ver 3.0)

### 共通事項
- **アクター**: ユーザー（Ore no Fusen 利用者）
- **システム境界**: アプリケーション（フロントエンド + バックエンド）

### 1. 初期化・セットアップ (Startup Phase)

#### UC-01: ベースフォルダの設定（初回起動）
- **アクター**: ユーザー
- **前提条件**: アプリが初回起動状態である（設定ファイル `settings.json` が存在しない、または無効）
- **基本フロー**:
  1. システムは設定ファイルの不在を検知し、「セットアップダイアログ」を表示する
  2. ユーザーは「A. 推奨作成（ドキュメント配下）」または「B. 既存フォルダ選択」を選ぶ
  3. [Aの場合]: システムは `Documents/OreNoFusen` を作成する
  4. [Bの場合]: ユーザーはフォルダ選択ダイアログで対象フォルダを指定する
  5. システムは決定されたパスを「ベースフォルダ」として設定ファイルに保存する
  6. ユーザーは「データの取り込み（インポート）」の要否を選択する（任意）
- **事後条件**: ベースフォルダが確定し、アプリが「通常起動モード」へ移行可能な状態になる

#### UC-02: データのインポート
- **アクター**: ユーザー
- **前提条件**: UC-01 のフロー内で、ユーザーがインポートを選択している
- **基本フロー**:
  1. ユーザーは「取り込み元フォルダ」を選択する
  2. システムは対象フォルダ内の全 `.md` ファイルを読み取る
  3. システムはファイル名を命名規則（`日付_1行目.md`）に適合するように変換しつつ、ベースフォルダへコピーする
- **事後条件**: 過去の資産がベースフォルダ内に複製され、利用可能になる（元データは変更されない）

#### UC-03: 環境構築（内部処理）
- **基本フロー**: ベースフォルダ作成時に、安全用の `trash`（ゴミ箱）フォルダも作成しておく

### 2. 付箋操作・編集 (Runtime Phase)

#### UC-06: 新規付箋の作成
- **基本フロー**:
  1. ユーザーは「新規メモ」を選択
  2. システムはベースフォルダ内に新規ファイル（例: `20260110_NewNote.md`）を作成
  3. 初期メタデータ（位置:マウス座標, 色:Yellow）を書き込み、画面に表示

#### UC-07: テキスト編集とファイル名同期
- **基本フロー**:
  1. ユーザーはテキスト入力
  2. システムは自動保存
  3. **「1行目の内容」と「現在のファイル名」を比較し、差異があればリネームする**（例: `日付_1行目.md`）。禁則文字は置換
- **事後条件**: ファイルの中身とファイル名が常に同期している

#### UC-08/09: メタデータ更新
- **基本フロー**: 移動・色変更時、フロントマターの `x`, `y`, `backgroundColor` のみを更新

#### UC-10: 付箋の削除（論理削除）
- **基本フロー**:
  1. ユーザーは「削除」を選択
  2. システムは対象ファイルを `trash` フォルダへ移動する（物理削除しない）
  3. 画面から消去

#### UC-11: エクスプローラーで開く
- **基本フロー**: ユーザーがコンテキストメニューから選択すると、システムはファイルマネージャーで実体を表示する

### 3. システム常駐 (System Tray)

#### UC-12: アプリケーション終了
- **基本フロー**: タスクトレイから「終了」を選択し、アプリを完全に終了する

#### UC-14/15: ボスキー (Boss Key)
- **基本フロー**: トレイアイコンから「全部隠す」「全部戻す」を選択し、全ウィンドウの表示/非表示を切り替える

## 主要機能と操作方法 (Features & Operations)

### 1. 付箋の作成と移動
- **新規作成**:
  - 付箋上で**右クリック**し、メニューから**「📝 新規メモ」**を選択します。
  - 現在のフォルダに新しい付箋が作成され、別ウィンドウで開きます。
  - **新規メモには完全なフロントマターが自動生成されます**（Δ0.7新機能）
- **移動とサイズ変更**:
  - 付箋の**余白（上部や下部）**をドラッグして移動できます。
  - **位置・サイズのリアルタイム保存**:
    - ウィンドウを動かすと、本文を保存することなく**座標情報のみが即座にファイルヘッダ(Frontmatter)に記録**されます。

### 2. 編集と保存
- **編集**:
  - 付箋内の**テキストをシングルクリック**すると編集モードになります。
- **自動保存**:
  - 入力を止めて少し待つと、自動的に保存されます。
  - 1行目のテキストがファイル名として自動的に使用されます。
- **リネーム**:
  - 1行目を書き換えると、自動的にファイル名も変更（リネーム）され、リンク切れを防ぎます。

### 3. デザイン変更
- **背景色の変更**:
  - 付箋上で**右クリック**し、**「🔵 Blue」「🌸 Pink」「💛 Yellow」**から選択します。
  - 瞬時に付箋全体の色が切り替わります。

### 4. システムトレイ（ボス機能）
- **一括操作**:
  - タスクトレイのアイコンから以下の操作が可能です。
    - **Hide All**: 全ての付箋を一瞬で隠します（ボスが来た時用）。
    - **Show All**: 全ての付箋を再表示し、最前面に持ってきます。
    - **Quit**: アプリを完全に終了します。

### 5. 削除
- **ゴミ箱へ移動**:
  - 付箋上で**右クリック**し、**「🗑️ 削除」**を選択します。
  - ファイルがゴミ箱に移動し、ウィンドウが自動的に閉じます。

## Δ0.7 新機能: 完全なフロントマター仕様

### フロントマターフィールド定義

新規メモ作成時、以下のフィールドを持つ完全なフロントマターが自動生成されます：

#### システム管理フィールド（必須）

| フィールド | 型 | 説明 | 例 |
|----------|---|------|---|
| `type` | string | ノートタイプ（固定値） | `sticky` |
| `seq` | number | 連番（同一フォルダ内でユニーク） | `1`, `12`, `100` |
| `context` | string | コンテキスト（ファイル名の一部） | `基礎数値`, `TODO` |
| `created` | string | 作成日（YYYY-MM-DD） | `2026-01-10` |
| `updated` | string | 更新日（YYYY-MM-DD） | `2026-01-10` |

#### 表示設定フィールド（維持対象）

| フィールド | 型 | デフォルト値 | 説明 |
|----------|---|-----------|------|
| `backgroundColor` | string | `#f7e9b0` | 付箋の背景色（16進数カラーコード） |
| `x` | number |（作成時の位置） | ウィンドウのX座標（ピクセル） |
| `y` | number | （作成時の位置） | ウィンドウのY座標（ピクセル） |
| `width` | number | `400` | ウィンドウの幅（ピクセル） |
| `height` | number | `300` | ウィンドウの高さ（ピクセル） |
| `fontFamily` | string | `BIZ UDGothic` | 使用フォント名 |
| `fontSize` | number | `8` | フォントサイズ（ピクセル） |
| `lineHeight` | number | `1.0` | 行間隔（倍数） |

### 標準フロントマター例

```yaml
---
type: sticky
seq: 12
context: 
created: 2026-01-10
updated: 2026-01-10
backgroundColor: #f7e9b0
x: 1065
y: 11
width: 300
height: 400
fontFamily: BIZ UDGothic
fontSize: 8
lineHeight: 1.0
---
```

### 自動保存の動作

1. **背景色変更時**: 色変更メニュー選択後、即座に`backgroundColor`を保存
2. **ウィンドウ移動時**: 移動完了から800ms後に`x`, `y`を自動保存
3. **ウィンドウリサイズ時**: リサイズ完了から800ms後に`width`, `height`を自動保存
4. **本文編集時**: 最後の編集から800ms後に`updated`フィールドとMarkdown本文を保存

### ファイル名規則

フォーマット: `{seq:04d}_{created}_{context}.md`

例:
- `0001_2026-01-10_基礎数値.md`
- `0012_2026-01-10_TODO.md`
- `0100_2026-01-10_.md` （コンテキストなし）

## 技術的工夫とアーキテクチャ (Engineering & Architecture)

### 1. Data-Oriented Design (DOD) & Effect Pattern
- **Rust Backend Modularization**:
  バックエンドを `logic.rs` (純粋計算), `state.rs` (純粋データ), `storage.rs` (I/O), `lib.rs` (API) に厳格に分離し、責務を明確化。
- **Effect Pattern**:
  Logic層は副作用（I/O）を直接行わず、「次に行うべき操作（Effect Enum）」のみを返す関数型アーキテクチャを採用（e.g., `handle_save_note` -> `Effect::WriteNote`）。これによりテスト容易性と安全性が飛躍的に向上しました。

### 2. Single Source of Truth (SSOT)
- **AppState Sync**:
  Rustバックエンドの `AppState` を唯一の正(Master)とし、Reactフロントエンドは `fusen_get_state` イベントを通じて常に完全な同期を保ちます。これにより、ディレクトリ変更や外部要因による状態不整合を排除しました。

### 3. Window & Resource Efficiency
- **Geometry Persistence Optimization**:
  ウィンドウ移動時には、本文書き込みを行わず Frontmatter の座標値のみを部分更新する専用コマンド (`fusen_update_geometry`) を使用。高速かつ安全な状態保存を実現しています。
- **Centralized Window Management**:
  ウィンドウ生成ロジックを `page.tsx` に一元化し、重複起動や不正なウィンドウ状態の発生を防止しています。

### 4. ネイティブOSコンテキストメニュー（Δ0.7新機能）
- **フロントエンド実装**:
  Tauri Menu APIをフロントエンドで使用し、OSネイティブのコンテキストメニューを実装。
- **削除機能の最適化**:
  バックエンド（`fusen_move_to_trash`）で直接ウィンドウを閉じることで、確実な削除処理を実現。
- **新規メモ作成**:
  `WebviewWindow`を直接作成することで、重複ウィンドウの発生を防止。

### 5. レンダリングとUX
- **Visual Fidelity (空白行維持)**:
  独自のMarkdownパーサーチューニングにより、エディタでの入力とビューアでの表示の完全な一致（WYSIWYGに近い体験）を実現しています。
- **Direct DOM Update**:
  背景色変更などの即応性が求められる操作には、Reactステートを介さずDOMを直接操作することでラグのないUXを提供しています。

## 技術スタック
- **Frontend**: Next.js 14, React 18, TypeScript
- **Backend**: Tauri v2 (Rust)
- **Storage**: Local Markdown files with YAML frontmatter

---

**詳細仕様**:
- [フロントマター仕様書](./俺の付箋_フロントマター仕様.md)

*作成日: 2026-01-10*  
*バージョン: Δ0.7*
