# 俺の付箋 - 要求仕様書 v1.2

**バージョン**: 1.2  
**日付**: 2026-01-20  
**ステータス**: ✅ リンク機能・タグフィルタリング完了

## 概要 (Overview)

「俺の付箋」は、Markdown ファイルをデスクトップ上の付箋として直接表示・編集できるミニマリスト・アプリケーションです。Obsidian Vault 等の Markdown 資産をそのまま活用でき、「**ファイルの中身 = ファイル名**」を自動同期し、従来のリンク切れを根本解決します。

## ユースケース定義 (Use Cases Ver 3.2)

### 共通事項
- **アクター**: ユーザー（Ore no Fusen 利用者）
- **システム境界**: アプリケーション（フロントエンド + バックエンド）

### 1. 初期化・セットアップ (Startup Phase)

#### UC-01: ベースフォルダの設定（初回起動）
- **アクター**: ユーザー
- **前提条件**: アプリが初回起動状態である（設定ファイル `settings.json` が存在しない、または無効）
- **基本フロー**:
  1. システムは設定ファイルの不在を検知し、「セットアップダイアログ」を表示する
  2. ユーザーは「A. 推奨作成（ドキュメント配下）」または「B. 既存フォルダ選択」を選ぶ
  3. [Aの場合]: システムは `Documents/OreNoFusen` を作成する
  4. [Bの場合]: ユーザーはフォルダ選択ダイアログで対象フォルダを指定する
  5. システムは決定されたパスを「ベースフォルダ」として設定ファイルに保存する
  6. ユーザーは「データの取り込み（インポート）」の要否を選択する（任意）
- **事後条件**: ベースフォルダが確定し、アプリが「通常起動モード」へ移行可能な状態になる

#### UC-02: データのインポート
- **アクター**: ユーザー
- **前提条件**: UC-01 のフロー内で、ユーザーがインポートを選択している
- **基本フロー**:
  1. ユーザーは「取り込み元フォルダ」を選択する
  2. システムは対象フォルダ内の全 `.md` ファイルを読み取る
  3. システムはファイル名を命名規則（`日付_1行目.md`）に適合するように変換しつつ、ベースフォルダへコピーする
- **事後条件**: 過去の資産がベースフォルダ内に複製され、利用可能になる（元データは変更されない）

#### UC-03: 環境構築（内部処理）
- **基本フロー**: ベースフォルダ作成時に、安全用の `trash`（ゴミ箱）フォルダも作成しておく

### 2. 付箋操作・編集 (Runtime Phase)

#### UC-06: 新規付箋の作成
- **基本フロー**:
  1. ユーザーは「新規メモ」を選択
  2. システムはベースフォルダ内に新規ファイル（例: `20260110_NewNote.md`）を作成
  3. 初期メタデータ（位置:マウス座標, 色:Yellow）を書き込み、画面に表示

#### UC-07: テキスト編集とファイル名同期 (Enhanced)
- **基本フロー**:
  1. ユーザーは高度なMarkdownエディタ（CodeMirror 6ベース）でテキスト入力。
  2. システムは0.8秒のディレイで自動保存。
  3. **「1行目の内容」と「現在のファイル名」を比較し、差異があればリネームする**（例: `日付_1行目.md`）。禁則文字は置換
- **エディタ機能の拡張 (v1.1)**:
  - **箇条書き（List）**: `- ` 記号をオレンジ色で強調表示。閲覧モードでは「•」に変換。
  - **チェックボックス（Task）**: `[ ]` 記号をオレンジ色で強調表示。
  - **複数行一括適用**: 複数行を選択してボタン（B, H1, List, Task）を押すと、全行に一括で記号を挿入/削除（スマートトグル）。
  - **スマート太字**: 選択範囲を `**` でトグル（ON/OFF）。二重装飾を防止。
- **編集モードの開始 (v1.2変更)**:
  - テキスト部分を**ダブルクリック**すると編集モードを開始。
  - シングルクリックでは移動操作と競合しないよう、編集モードには移行しない。

#### UC-21: インタラクティブ・チェックボックス (v1.1新設)
- **基本フロー**:
  1. ユーザーは表示モード（閲覧モード）でチェックボックスアイコン（☐/☑）をクリックする。
  2. システムはエディタを起動せずに、内部テキストの該当行を `[ ]` ⇔ `[x]` に書き換える。
  3. システムは即座に表示を更新し、自動保存を実行する。

#### UC-22: リンククリック (v1.2新設)
- **アクター**: ユーザー
- **基本フロー**:
  1. ユーザーは表示モードでリンクをクリックする。
  2. システムは以下のリンクタイプを判別し、適切な方法で開く：
     - **WebリンクURL** (`https://...`, `http://...`): 外部ブラウザで開く
     - **Markdownリンク** (`[テキスト](URL)`): リンク先を外部ブラウザで開く
     - **ローカルファイルパス** (`C:\...`, `D:\...`): ファイルエクスプローラーで対象を表示
  3. リンクはクリック時に編集モードに移行しない（表示モードを維持）。

#### UC-08/09: メタデータ更新
- **基本フロー**: 移動・色変更時、フロントマターの `x`, `y`, `backgroundColor` のみを更新

#### UC-10: 付箋の削除（論理削除）
- **基本フロー**:
  1. ユーザーは「削除」を選択
  2. システムは対象ファイルを `trash` フォルダへ移動する（物理削除しない）
  3. 画面から消去
  4. 削除時にサウンドエフェクトを再生（v1.2）

#### UC-11: エクスプローラーで開く
- **基本フロー**: ユーザーがコンテキストメニューから選択すると、システムはファイルマネージャーで実体を表示する

### 3. 表示とレイアウト (Layout Phase)

#### UC-20: 高度なレイアウト同期 (v1.1新設)
- **アクター**: システム
- **基本フロー**: 
  1. 編集モード（エディタ）と表示モード（レンダリング）の間で、フォント、余白、行高を完全に一致させる。
  2. モードを切り替えた際に、テキストの垂直・水平位置が1ピクセルも変動しない（WYSIWYG体験の提供）。
- **ツールバーの固定表示**: 長いメモをスクロールしても、装飾ボタンが常に画面最上部に追従（Sticky表示）する。

### 4. タグ管理 (v1.2新設)

#### UC-23: タグの追加
- **アクター**: ユーザー
- **基本フロー**:
  1. ユーザーは右クリックメニューから「🏷️ タグ」サブメニューを選択。
  2. ユーザーは既存タグから選択、または新規タグ名を入力。
  3. システムはフロントマターの `tags` 配列に追加。
- **事後条件**: タグがヘッダー部分にチップとして表示される。

#### UC-24: タグの削除
- **アクター**: ユーザー
- **基本フロー**:
  1. ユーザーは右クリックメニューから「🏷️ タグ」→「削除モード」を選択。
  2. ユーザーは削除するタグを選択。
  3. システムはフロントマターの `tags` 配列から削除。

#### UC-25: マルチタグフィルタリング (v1.2新設)
- **アクター**: ユーザー
- **基本フロー**:
  1. ユーザーはシステムトレイから「🏷️ タグで絞り込み」を選択。
  2. タグ選択ウィンドウが表示され、チェックボックスで**複数タグを選択可能**。
  3. システムは選択されたタグの**いずれか**を持つ付箋を表示（OR条件）。
  4. 選択外の付箋は非表示になる。
  5. 「全解除」ボタンで全ての付箋を表示。

### 5. システム常駐 (System Tray)

#### UC-12: アプリケーション終了
- **基本フロー**: タスクトレイから「終了」を選択し、アプリを完全に終了する

#### UC-14/15: ボスキー (Boss Key)
- **基本フロー**: トレイアイコンから「全部隠す」「全部戻す」を選択し、全ウィンドウの表示/非表示を切り替える

## 主要機能と操作方法 (Features & Operations)

### 1. 付箋の作成と移動
- **新規作成**:
  - 付箋上で**右クリック**し、メニューから**「📝 新規メモ」**を選択します。
  - 現在のフォルダに新しい付箋が作成され、別ウィンドウで開きます。
- **移動とサイズ変更**:
  - 付箋の**余白（上部や下部）**をドラッグして移動できます。

### 2. 編集と装飾 (v1.2更新)
- **リッチ・エディタ**:
  - CodeMirror 6を採用し、Markdown記号をオレンジ色で見やすく装飾。
  - **ツールバーアイコン**: 直感的なSVGアイコンを採用。
- **編集モード開始**:
  - テキスト部分を**ダブルクリック**で編集モードを開始。
- **スマート・トグル**: 
  - 単語や複数行を選択してボタンを押すと、適切に装飾を付与/解除。
  - 特に太字（B）は二重装飾（`****`）を防ぐ賢い挙動に改善。
- **閲覧モードでの直接操作**:
  - チェックボックスを直接クリックしてタスクを完了できます。
  - **リンクをクリック**してWebページやローカルファイルを開けます（v1.2）。

### 3. 付箋の外観カスタマイズ
- **背景色の変更**:
  - 右クリックメニューから「🎨 色を変更」を選択。
  - Blue（`#80d8ff`）、Pink（`#ffcdd2`）、Yellow（`#f7e9b0`）の3色から選択可能。
- **自動保存**: 色の変更は即座にフロントマターに保存されます。

### 4. ファイル管理と削除
- **論理削除**:
  - 右クリックメニューから「🗑️ 削除」を選択すると、ファイルは `trash` フォルダへ移動します。
  - 物理削除されないため、必要に応じて復元可能です。
  - 削除時にサウンドエフェクトが再生されます（v1.2）。
- **エクスプローラーで開く**:
  - 右クリックメニューから「📂 エクスプローラーで開く」を選択すると、ファイルマネージャーで対象ファイルの場所が開きます。

### 5. タグ管理 (v1.2新設)
- **タグの追加**:
  - 右クリックメニュー → 「🏷️ タグ」からタグを追加。
  - ヘッダー部分にタグがチップとして表示（最大3つ、超過は`+N`表示）。
- **タグで絞り込み**:
  - システムトレイ → 「🏷️ タグで絞り込み」から選択。
  - 複数タグを同時選択可能（OR条件でフィルタ）。

### 6. システムトレイとボスキー
- **常駐**: アプリはシステムトレイに常駐し、付箋ウィンドウを閉じてもバックグラウンドで動作します。
- **ボスキー機能**:
  - トレイアイコンから「全部隠す」を選択すると、全ての付箋ウィンドウを一時的に非表示にできます。
  - 「全部戻す」で再表示します。

## 技術的工夫とアーキテクチャ (Engineering & Architecture)

### 1. アーキテクチャ概要
- **フレームワーク**: Tauri 2.x (Rust + Next.js)
- **フロントエンド**: Next.js 14 (App Router) + TypeScript + React 18
- **スタイリング**: Vanilla CSS（最小限のフレームワーク依存）
- **エディタ**: CodeMirror 6
- **Markdown処理**: react-markdown + remark-gfm
- **外部リンク**: tauri-plugin-shell (v1.2追加)

### 2. Rust側アーキテクチャ (DOD + Effect Pattern)
- **Data-Oriented Design (DOD)**:
  - データとロジックを明確に分離し、副作用を持たない純粋な関数として設計。
  - ビジネスロジックは「Effect（副作用の記述）」を返却するのみで、実行はCommandレイヤーが担当。
- **AppState (SSOT)**:
  - アプリ全体の状態を一元管理する `AppState` を定義。
  - 全てのウィンドウ、ファイルパス、メタデータ、**アクティブタグ**はここに集約。
- **レイヤー構造**:
  - **Command層**: Tauriコマンドのエントリーポイント。UI→Rustの入口。
  - **Logic層**: ビジネスロジックを実装。副作用を返却するのみ（実行しない）。
  - **Effect層**: ファイルI/O、ウィンドウ操作などの副作用を実行。

### 3. ファイル名とFrontmatter同期
- **自動リネーム**:
  - テキストの1行目が変更されると、ファイル名を `YYYYMMDD_1行目.md` 形式に自動変更。
  - 禁則文字（`/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`）は自動的に `_` に置換。
- **Window Label同期**:
  - ファイル名が変更されると、Tauriウィンドウのラベルも自動更新（重複ウィンドウの防止）。

### 4. ウィンドウ管理（重複防止）
- **一意なラベル**: 各付箋ウィンドウには、ファイルパスから生成した一意のラベルを付与。
- **起動時の重複チェック**:
  - 付箋を開く前に、同じラベルのウィンドウが既に存在するかチェック。
  - 存在する場合は新規作成せず、既存ウィンドウをフォーカス。
- **フロントエンド側の排他制御**: 
  - 非同期処理中の重複リクエストを防ぐため、Set型で開封中のファイルパスを管理。

### 5. レンダリングとUX (v1.2拡張)
- **Pixel-Perfect Alignment**:
  - CodeMirrorの各行（`.cm-line`）と、Reactで描画する表示行の CSS プロパティを物理的に同一値に設定。
  - モード切り替え時の視覚的ノイズをゼロに（WYSIWYG体験）。
- **Sticky Toolbar**:
  - `position: sticky` を利用し、スクロール領域内でもツールバーが常に画面上部に追従。
- **Interactive Checklist**:
  - 表示モードのDOMイベントをインターセプトし、チェックボックスクリック時のみ本文テキストを書き換え。
  - エディタを起動せずに、部分再描画と自動保存を連動させることで、シームレスなタスク管理を実現。
- **クリッカブルリンク (v1.2)**:
  - URL、Markdownリンク、ローカルファイルパスを自動検出し、クリック可能なリンクとして表示。
  - リンククリック時は編集モードへの移行を抑制。

### 6. パフォーマンス最適化
- **Debounce自動保存**: テキスト変更後、800msの遅延を設けて自動保存（連続入力時の負荷軽減）。
- **メタデータの部分更新**: 移動や色変更時は、フロントマターの該当フィールド（`x`, `y`, `backgroundColor`）のみを更新。
- **Optimistic UI (v1.2)**: 新規付箋作成時、バックエンド応答を待たずにUIを即座に更新。

### 7. セキュリティとデータ保護
- **論理削除**: ファイル削除時は `trash` フォルダへ移動し、誤削除時の復旧を可能に。
- **ローカル完結**: 全てのデータはユーザーのローカル環境に保存され、外部サーバーへの送信は一切なし。

---

*作成日: 2026-01-12*  
*最終更新: 2026-01-20*  
*バージョン: v1.2*  
*ステータス: ✅ リンク機能・タグフィルタリング完了*
