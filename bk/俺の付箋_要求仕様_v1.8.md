# 俺の付箋 - 要求仕様書 v1.9 (Release Candidate)

**バージョン**: 1.9  
**日付**: 2026-01-31  
**形式**: USDM (Universal Specification Describing Manner)  
**ステータス**: ✅ リリース準備完了 (Ready for Release)

---

# 1. 全体概要 (General Overview)

## 1.1 製品定義
- **要求**: ユーザーは、デスクトップ上で手軽にメモを取り、それらをファイルとして永続化・管理できるアプリケーションを求めている。
- **理由**: 既存の付箋アプリはデータのポータビリティが低く、テキストエディタは起動や管理が手軽でないため。
- **仕様**:
  - **[SPEC-SYS-01]**: アプリケーション名は「俺の付箋 (OreNoFusen)」とする。
  - **[SPEC-SYS-02]**: Windows デスクトップアプリケーションとして動作し、.exe 形式で配布される。
  - **[SPEC-SYS-03]**: データの実体はプレーンテキスト（Markdown）とし、独自データベースを持たない。

---

# 2. ライフサイクル要件 (Lifecycle Requirements)

## [REQ_LF_01] アプリケーションの常駐と起動
- **要求**: ユーザーは、アプリを常に起動状態のまま維持し、必要な時に素早くメモを確認したい。
- **理由**: メモを取りたい瞬間に起動待ち時間が発生すると、思考が中断されるため。
- **仕様**:
  - **[SPEC-LF-01-01]**: アプリケーションはシステムトレイに常駐する。
  - **[SPEC-LF-01-02]**: 起動時、設定されたフォルダ（Vault）をスキャンし、以前の状態（位置・サイズ）で付箋ウィンドウを復元する。
  - **[SPEC-LF-01-03]**: ウィンドウの復元は、負荷分散のためキューシステムを用いて順次行う。

### 補足: 起動シーケンス
```mermaid
sequenceDiagram
    participant User
    participant Page as page.tsx (Orchestrator)
    participant Rust as Backend (Rust)
    participant Win as Note Windows

    User->>Rust: アプリ起動
    Rust->>Page: 初期化完了
    Page->>Rust: fusen_get_state()
    Rust->>Rust: 設定読み込み & ノート一覧取得
    Rust-->>Page: AppState (Notes List)
    
    alt base_path 未設定
        Page->>Page: Setup画面表示 (Resize 900x630)
        User->>Page: フォルダ選択
        Page->>Rust: setup_first_launch()
    else 設定済み
        Page->>Page: Dashboard表示 (Resize 240x300)
    end

    loop 各ノート
        Page->>Page: __WINDOW_QUEUE__.push()
        Page->>Win: WebviewWindow生成 (x, y, width, height)
    end
```

## [REQ_LF_02] 初回セットアップ
- **要求**: ユーザーは、最初にアプリを使用した際に、メモの保存場所を自分で決めたい。
- **理由**: デフォルトの場所に勝手に保存されると、ユーザーのファイル管理ポリシーに反する場合があるため。
- **仕様**:
  - **[SPEC-LF-02-01]**: 初回起動時（設定ファイルが存在しない場合）、セットアップ画面を表示する。
  - **[SPEC-LF-02-02]**: ユーザーにフォルダ選択ダイアログを提示し、選択されたパスを「ベースフォルダ」として保存する。
  - **[SPEC-LF-02-03]**: セットアップ完了後、メインウィンドウをダッシュボードモード（小型）に切り替える。

## [REQ_LF_03] 新規付箋の作成
- **要求**: ユーザーは、思いついたその瞬間に新しいメモを書き始めたい。
- **理由**: 操作の手数が多すぎると、メモを取る意欲が減退するため。
- **仕様**:
  - **[SPEC-LF-03-01]**: システムトレイメニュー、または既存付箋の右クリックメニューから「新規メモ」を実行できる。
  - **[SPEC-LF-03-02]**: 作成操作後、即座に新しいウィンドウが開き、入力可能な状態になる。
  - **[SPEC-LF-03-03]**: ファイル名は作成日時から自動生成 (`NNNN_YYYY-MM-DD_Context.md`) し、ユーザーに入力を求めない。

## [REQ_LF_04] アプリケーションの終了
- **要求**: ユーザーは、メンテナンスやPC終了時にアプリを完全に停止させたい。
- **理由**: 常駐アプリであっても、ユーザーの意思でプロセスを終了させる手段が必要不可欠であるため。
- **仕様**:
  - **[SPEC-LF-04-01]**: 個別の付箋を「閉じる（非表示にする）」汎用ボタンは提供しない。ユーザーは「アーカイブ」または「削除」を選択することで付箋をデスクトップから消去する。
  - **[SPEC-LF-04-02]**: システムトレイメニューの「終了」を選択した場合のみ、全プロセスを終了する。

---

# 3. データ管理要件 (Data Requirements)

## [REQ_DT_01] Markdown形式での保存
- **要求**: ユーザーは、メモの内容を他のテキストエディタやツールでも閲覧・編集したい。
- **理由**: 独自フォーマットによるベンダーロックインを避け、長期的なデータの可読性を保証するため。
- **仕様**:
  - **[SPEC-DT-01-01]**: ファイル拡張子は `.md` とする。
  - **[SPEC-DT-01-02]**: 本文は標準的な Markdown 記法で保存する。

## [REQ_DT_02] メタデータの管理
- **要求**: ユーザーは、前回終了時のウィンドウ位置やサイズ、色を維持したい。
- **理由**: デスクトップ上の配置自体が情報の整理・優先度付けの意味を持つため。
- **仕様**:
  - **[SPEC-DT-02-01]**: `windowX`, `windowY`, `width`, `height`, `backgroundColor`, `tags`, `alwaysOnTop` 等の情報を YAML Frontmatter 形式でファイル先頭に記録する。
  - **[SPEC-DT-02-02]**: アプリ以外のエディタで開いた際も、本文の可読性を損なわない形式とする。

## [REQ_DT_03] ファイル名の自動同期
- **要求**: ユーザーは、ファイル名を管理する手間から解放されたい。
- **理由**: ファイル名を考える時間はメモの本質的な価値とは無関係であり、認知負荷を下げるため。
- **仕様**:
  - **[SPEC-DT-03-01]**: 本文の1行目をファイル名の「コンテキスト」部分として使用する。
  - **[SPEC-DT-03-02]**: 1行目が変更された場合、0.8秒の待機時間（デバウンス）を経て自動的にリネームを実行する。
  - **[SPEC-DT-03-03]**: ファイルシステムで使用できない文字（`\ / : * ? " < > |`）は半角スペース等に自動置換してサニタイズする。

### 補足: 自動リネームフロー
```mermaid
sequenceDiagram
    participant Editor as エディタ
    participant Logic as リネームロジック
    participant FS as ファイルシステム
    
    Editor->>Editor: 1行目変更検知
    Editor->>Logic: 800ms後に発火
    Logic->>Logic: 新ファイル名生成
    Logic->>FS: rename実行
    FS-->>Logic: 新パス返却
    Logic->>Editor: パス更新
```

## [REQ_DT_04] 変更の自動保存
- **要求**: ユーザーは、保存ボタンを押す操作を意識したくない。
- **理由**: 保存忘れによるデータ消失を防ぎ、紙の付箋のような「書けば残る」体験を提供するため。
- **仕様**:
  - **[SPEC-DT-04-01]**: テキスト変更後、自動的にファイルシステムへ書き込みを行う。
  - **[SPEC-DT-04-02]**: ウィンドウからフォーカスが外れた（Blur）時点で、未保存の変更があれば即座に保存する。

---

# 4. 編集・表示要件 (Editing Requirements)

## [REQ_ED_01] リッチテキスト編集
- **要求**: ユーザーは、強調やリストなどの構造を使ってメモを見やすくしたい。
- **理由**: プレーンテキストだけでは情報のメリハリが付けにくく、視認性が低いため。
- **仕様**:
  - **[SPEC-ED-01-01]**: `**太字**` は赤色・太字で表示する（重要事項の強調）。
  - **[SPEC-ED-01-02]**: `# 見出し` はフォントサイズを大きく表示する。
  - **[SPEC-ED-01-03]**: `[ ]` / `[x]` はクリック可能なチェックボックスとして表示する。
  - **[SPEC-ED-01-04]**: 編集モードと表示モードをダブルクリックで切り替える。
  - **[SPEC-ED-01-05]**: **[v1.9追加]** 元に戻す/やり直し（Undo/Redo）をサポートする。

## [REQ_ED_02] 画像の取り込み
- **要求**: ユーザーは、画面上の情報をスクリーンショットとして素早くメモに貼りたい。
- **理由**: テキスト化しにくいビジュアル情報を、コンテキストを失わずに保存するため。
- **仕様**:
  - **[SPEC-ED-02-01]**: ツールバーのカメラボタン押下で、OSのスクリーンショットツールを起動する（Windows Snipping Tool連携）。
  - **[SPEC-ED-02-02]**: クリップボード内の画像を `assets` フォルダに自動保存し、Markdown リンクとして挿入する。
  - **[SPEC-ED-02-03]**: エディタ上の画像はドラッグ操作で表示サイズ（倍率）を変更できる。

### 補足: 画像キャプチャフロー
```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Fusen as 付箋
    participant Snip as SnippingTool
    participant FS as ファイルシステム
    
    User->>Fusen: 📷クリック
    Fusen->>Fusen: 全付箋を一時非表示
    Fusen->>Snip: 起動
    User->>Snip: 範囲選択
    Snip->>FS: クリップボードに画像
    Fusen->>FS: assets/へ保存
    Fusen->>Fusen: Markdown挿入
    Fusen->>Fusen: 全付箋を再表示
```

---

# 5. 検索・整理要件 (Organization Requirements)

## [REQ_OR_01] 全文検索
- **要求**: ユーザーは、大量のメモの中から特定のキーワードを含むものを即座に見つけたい。
- **理由**: メモが増えるにつれて、視覚的な探索だけでは目的の情報に到達するのが困難になるため。
- **仕様**:
  - **[SPEC-OR-01-01]**: `Ctrl+F` またはトレイメニューから検索画面を開く。
  - **[SPEC-OR-01-02]**: 入力されたキーワードで全 `.md` ファイルを Grep 検索する（Grepライク検索）。
  - **[SPEC-OR-01-03]**: 検索結果をクリックすると、該当する付箋ウィンドウを開き（最前面へ移動）、該当行へスクロール・ハイライトする。
  - **[SPEC-OR-01-04]**: 検索ウィンドウは「×」ボタンで閉じられてもプロセスは終了せず、バックグラウンド待機（Hide）し、何度でも再呼び出し可能とする。
  - **[SPEC-OR-01-05]**: 検索結果の行数表示は、ユーザーに見えている本文の行番号と一致させる（Frontmatter除外計算）。

### 補足: 全文検索フロー
```mermaid
sequenceDiagram
    participant User
    participant Sticky as Setup/Tray
    participant Page as page.tsx
    participant Search as SearchOverlay
    participant Rust
    participant Target as StickyNote

    User->>Sticky: Ctrl+F または トレイ「検索」
    Sticky->>Page: emit('fusen:open_search')
    Page->>Page: setIsSearchOpen(true)
    Page->>Page: win.setSize(550, 450)
    Page->>Search: Render Overlay

    User->>Search: "keyword" 入力 + Enter
    Search->>Rust: fusen_search_notes("keyword")
    Rust-->>Search: Scan .md files -> SearchHit[]
    Search->>User: 結果リスト表示
    
    note right of Search: [Fix v1.8] Line# = Raw# - (Frontmatter + EmptyLines)

    User->>Search: 結果クリック
    Search->>Page: emit('fusen:scroll_to_line', {path, line, query})
    Target->>Target: highlightQuery(query)
    Target->>Target: Set Cursor & Scroll
```

## [REQ_OR_02] タグによるコンテキスト切り替え
- **要求**: ユーザーは、現在の作業（仕事、プライベートなど）に関連するメモだけを表示したい。
- **理由**: 無関係なメモがデスクトップにあると集中を阻害するため。
- **仕様**:
  - **[SPEC-OR-02-01]**: 付箋に任意のタグ（複数可）を設定できる。
  - **[SPEC-OR-02-02]**: 「タグで絞り込み」機能により、選択したタグを持つ付箋のみを表示し、それ以外を非表示にする。

## [REQ_OR_03] 不要メモの整理（アーカイブ・削除）
- **要求**: ユーザーは、アクティブでないメモをデスクトップから退避させたい。
- **理由**: デスクトップ領域は有限であり、常に現在進行形の情報のみを配置したいため。
- **仕様**:
  - **[SPEC-OR-03-01]**: **アーカイブ機能**:
    - 通常のノート: `Archive/` フォルダへ移動する。
    - タグ付きノート: 最初のタグのフォルダ（例: `tags/Work/`）へ移動し、2つ目以降のタグについては別フォルダへのリンク（Hard Link / Symlink）を作成して分類を維持する。
    - アセット同期: ノートに関連する `assets` 内の画像も同時に移動・コピーする。
  - **[SPEC-OR-03-02]**: **削除機能**:
    - ノートを `Trash/` フォルダへ移動する。論理削除ではなく物理移動とする。

---

# 6. UI/UX 仕様 (User Interface Specifications)

## [REQ_UI_01] ウィンドウデザイン・外観
- **要求**: ユーザーは、愛着の持てる「かわいくてシンプル」な外観を求めている。
- **理由**: 常にデスクトップに表示されるため、事務的すぎるデザインはユーザー体験を損なう。
- **仕様**:
  - **[SPEC-UI-01-01]**: ウィンドウ枠（Decorations）を無効化し、背景を透過・角丸デザインとする。
  - **[SPEC-UI-01-02]**: 背景色はユーザーが任意に選択できる（デフォルト: 淡い黄色）。
  - **[SPEC-UI-01-03]**: **[v1.9追加]** アプリケーションアイコンは「シンプルでかわいい」デザイン（線画、角折れドキュメント、比率調整済み）を採用し、Windows/Mac各OSに最適化された形式で提供する。

## [REQ_UI_02] コンテキストメニュー
- **要求**: ユーザーは、付箋に対する操作を右クリックから直感的に行いたい。
- **仕様**:
  - **[SPEC-UI-02-01]**: 右クリック時に独自メニューを表示する。
  - **[SPEC-UI-02-02]**: メニューには以下の項目を含める：
    - 新規作成、色変更、タグ管理、アーカイブ（整理）、ゴミ箱（削除）、常に手前に表示

---

# 7. インターフェース仕様 (Technical Interface)

## [REQ_IF_01] フロントエンド-バックエンド間通信
- **要求**: UI操作は、安全かつ効率的にファイルシステムへ反映されなければならない。
- **仕様**:
  - **[SPEC-IF-01-01]**: 非同期コマンド (`invoke`) を使用してファイル操作を要求する。
  - **[SPEC-IF-01-02]**: システムイベント（設定変更、外部リロード）は Tauri イベントシステム (`emit`/`listen`) で通知する。

## [REQ_IF_02] 設定の永続化
- **要求**: アプリの設定（ベースフォルダ等）は再起動しても維持されなければならない。
- **仕様**:
  - **[SPEC-IF-02-01]**: 設定は JSON 形式で AppData ディレクトリに保存する。
